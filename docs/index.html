<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@api-platform/zod â€” Demo</title>
    <style>
      *,
      *::before,
      *::after {
        box-sizing: border-box;
      }
      body {
        font-family:
          system-ui,
          -apple-system,
          sans-serif;
        max-width: 860px;
        margin: 0 auto;
        padding: 2rem 1rem;
        color: #1a1a1a;
        background: #fafafa;
        line-height: 1.5;
      }
      h1 {
        font-size: 1.5rem;
        margin-bottom: 0.25rem;
      }
      h1 span {
        color: #6b7280;
        font-weight: 400;
      }
      p.subtitle {
        color: #6b7280;
        margin-top: 0;
      }
      section {
        background: #fff;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 1.25rem;
        margin-bottom: 1.25rem;
      }
      section h2 {
        font-size: 1.1rem;
        margin: 0 0 0.75rem;
      }
      label {
        font-weight: 500;
        display: block;
        margin-bottom: 0.25rem;
        font-size: 0.9rem;
      }
      input[type="text"],
      textarea {
        width: 100%;
        padding: 0.5rem 0.75rem;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        font-family: inherit;
        font-size: 0.9rem;
      }
      textarea {
        min-height: 120px;
        font-family: ui-monospace, monospace;
        font-size: 0.8rem;
      }
      button {
        padding: 0.5rem 1rem;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.875rem;
        font-weight: 500;
        transition: opacity 0.15s;
      }
      button:hover {
        opacity: 0.85;
      }
      button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      .btn-primary {
        background: #2563eb;
        color: #fff;
      }
      .btn-secondary {
        background: #e5e7eb;
        color: #1a1a1a;
      }
      .btn-success {
        background: #16a34a;
        color: #fff;
      }
      .input-row {
        display: flex;
        gap: 0.5rem;
        align-items: end;
      }
      .input-row .field {
        flex: 1;
      }
      #status {
        margin-top: 0.5rem;
        font-size: 0.875rem;
        min-height: 1.25rem;
      }
      .status-loading {
        color: #2563eb;
      }
      .status-error {
        color: #dc2626;
      }
      .status-ok {
        color: #16a34a;
      }
      .resource-list {
        display: flex;
        flex-wrap: wrap;
        gap: 0.375rem;
        margin-bottom: 1rem;
      }
      .resource-btn {
        font-size: 0.8rem;
        padding: 0.35rem 0.75rem;
        border-radius: 999px;
      }
      .resource-btn.active {
        background: #2563eb;
        color: #fff;
      }
      #schema-display {
        background: #f9fafb;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        padding: 1rem;
        font-family: ui-monospace, monospace;
        font-size: 0.8rem;
        white-space: pre;
        overflow-x: auto;
        min-height: 60px;
        color: #374151;
      }
      #schema-display:empty::after {
        content: "Select a resource above.";
        color: #9ca3af;
      }
      .result-box {
        margin-top: 0.75rem;
        padding: 0.75rem 1rem;
        border-radius: 6px;
        font-family: ui-monospace, monospace;
        font-size: 0.8rem;
        white-space: pre-wrap;
        word-break: break-word;
        max-height: 300px;
        overflow-y: auto;
      }
      .result-ok {
        background: #f0fdf4;
        border: 1px solid #bbf7d0;
        color: #166534;
      }
      .result-err {
        background: #fef2f2;
        border: 1px solid #fecaca;
        color: #991b1b;
      }
      .actions {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
        align-items: center;
        margin-bottom: 0.5rem;
      }
      hr {
        border: none;
        border-top: 1px solid #e5e7eb;
        margin: 1rem 0;
      }
    </style>
    <script type="importmap">
      {
        "imports": {
          "zod": "https://esm.sh/zod@4",
          "zod/v4": "https://esm.sh/zod@4/v4",
          "@api-platform/api-doc-parser": "https://esm.sh/@api-platform/api-doc-parser",
          "@api-platform/zod": "https://esm.sh/gh/api-platform/zod@main/src/index.js"
        }
      }
    </script>
  </head>
  <body>
    <h1>@api-platform/zod <span>demo</span></h1>
    <p class="subtitle">
      Generate Zod schemas from a Hydra API and validate live responses.
    </p>

    <!-- Section 1: URL Input -->
    <section>
      <h2>1. Connect to an API</h2>
      <div class="input-row">
        <div class="field">
          <label for="entrypoint">Entrypoint URL</label>
          <input
            type="text"
            id="entrypoint"
            value="https://demo.api-platform.com"
          />
        </div>
        <button class="btn-primary" id="load-btn">Load</button>
      </div>
      <div id="status"></div>
    </section>

    <!-- Section 2: Schema Explorer -->
    <section id="explorer-section" hidden>
      <h2>2. Schema Explorer</h2>
      <div class="resource-list" id="resource-list"></div>
      <div id="schema-display"></div>
    </section>

    <!-- Section 3: Live Validation -->
    <section id="validation-section" hidden>
      <h2>3. Live Validation</h2>
      <div class="actions">
        <button class="btn-success" id="fetch-validate-btn">
          Fetch &amp; Validate
        </button>
        <span
          id="fetch-target"
          style="font-size: 0.8rem; color: #6b7280"
        ></span>
      </div>
      <div id="fetch-result"></div>
      <hr />
      <label for="custom-json"
        >Paste custom JSON to validate against the selected resource
        schema:</label
      >
      <textarea
        id="custom-json"
        placeholder='{ "@id": "/books/1", "@type": "Book", ... }'
      ></textarea>
      <div style="margin-top: 0.5rem">
        <button class="btn-secondary" id="validate-custom-btn">
          Validate JSON
        </button>
      </div>
      <div id="custom-result"></div>
    </section>

    <script type="module">
      import { z } from "zod/v4";
      import { createSchemas } from "@api-platform/zod";

      // --- State ---
      let state = {
        schemas: null,
        collections: null,
        resources: null,
        selected: null,
      };

      // --- DOM refs ---
      const $status = document.getElementById("status");
      const $loadBtn = document.getElementById("load-btn");
      const $entrypoint = document.getElementById("entrypoint");
      const $resourceList = document.getElementById("resource-list");
      const $schemaDisplay = document.getElementById("schema-display");
      const $explorerSection = document.getElementById("explorer-section");
      const $validationSection = document.getElementById("validation-section");
      const $fetchValidateBtn = document.getElementById("fetch-validate-btn");
      const $fetchTarget = document.getElementById("fetch-target");
      const $fetchResult = document.getElementById("fetch-result");
      const $customJson = document.getElementById("custom-json");
      const $validateCustomBtn = document.getElementById("validate-custom-btn");
      const $customResult = document.getElementById("custom-result");

      // --- Helpers ---
      function setStatus(text, cls) {
        $status.textContent = text;
        $status.className = cls ? `status-${cls}` : "";
      }

      function resultBox(container, ok, text) {
        container.innerHTML = "";
        const div = document.createElement("div");
        div.className = `result-box ${ok ? "result-ok" : "result-err"}`;
        div.textContent = text;
        container.appendChild(div);
      }

      /** Describe a Zod schema type in a human-readable way. */
      function describeZodType(schema) {
        if (!schema || !schema._zod) return "unknown";
        const def = schema._zod.def;
        const type = def.type;

        if (type === "string") {
          // Check for format checks (email, url, uuid, date, datetime, time)
          if (def.checks?.length) {
            const fmt = def.checks.find((c) => c.format);
            if (fmt) return `string (${fmt.format})`;
          }
          return "string";
        }
        if (type === "number") {
          if (def.checks?.some((c) => c.kind === "int")) return "int";
          return "number";
        }
        if (type === "boolean") return "boolean";
        if (type === "literal") return `literal(${JSON.stringify(def.values)})`;
        if (type === "enum") return `enum(${def.entries.join(", ")})`;
        if (type === "array") return `array<${describeZodType(def.element)}>`;
        if (type === "optional")
          return `optional<${describeZodType(def.innerType)}>`;
        if (type === "nullable")
          return `nullable<${describeZodType(def.innerType)}>`;
        if (type === "lazy") {
          try {
            return describeZodType(def.getter());
          } catch {
            return "lazy<...>";
          }
        }
        if (type === "object") return "object";
        return type || "unknown";
      }

      /** Build a field description table for a resource schema. */
      function describeSchema(schema) {
        const shape = schema._zod?.def?.shape;
        if (!shape) return "(unable to inspect schema)";

        const lines = [];
        const maxName = Math.max(...Object.keys(shape).map((k) => k.length));
        for (const [name, fieldSchema] of Object.entries(shape)) {
          const desc = describeZodType(fieldSchema);
          lines.push(`${name.padEnd(maxName)}  ${desc}`);
        }
        return lines.join("\n");
      }

      function guessCollectionUrl(entrypoint, resourceName) {
        // Use the resource URL from the parsed resources if available
        const resource = state.resources?.find((r) => r.name === resourceName);
        if (resource?.url) return resource.url;
        // Fallback: lowercase plural guess
        return `${entrypoint.replace(/\/$/, "")}/${resourceName.toLowerCase()}s`;
      }

      // --- Load API ---
      $loadBtn.addEventListener("click", async () => {
        const entrypoint = $entrypoint.value.trim();
        if (!entrypoint) return;

        setStatus("Loading API documentation...", "loading");
        $loadBtn.disabled = true;
        $explorerSection.hidden = true;
        $validationSection.hidden = true;
        $resourceList.innerHTML = "";
        $schemaDisplay.textContent = "";
        state = {
          schemas: null,
          collections: null,
          resources: null,
          selected: null,
        };

        try {
          const result = await createSchemas(entrypoint);
          state.schemas = result.schemas;
          state.collections = result.collections;
          state.resources = result.resources;

          const names = Object.keys(state.schemas);
          if (!names.length)
            throw new Error("No resources found in API documentation.");

          setStatus(`Loaded ${names.length} resource(s).`, "ok");
          $explorerSection.hidden = false;

          for (const name of names) {
            const r = state.resources?.find((r) => r.name === name);
            const label = r?.title || name;
            const btn = document.createElement("button");
            btn.className = "btn-secondary resource-btn";
            btn.textContent = label;
            btn.dataset.name = name;
            btn.addEventListener("click", () => selectResource(name));
            $resourceList.appendChild(btn);
          }

          // Auto-select first
          selectResource(names[0]);
        } catch (err) {
          setStatus(`Error: ${err.message}`, "error");
          console.error(err);
        } finally {
          $loadBtn.disabled = false;
        }
      });

      function selectResource(name) {
        state.selected = name;
        // Update active button
        for (const btn of $resourceList.children) {
          btn.classList.toggle("active", btn.dataset.name === name);
        }
        // Show schema
        $schemaDisplay.textContent = describeSchema(state.schemas[name]);
        // Show validation section
        $validationSection.hidden = false;
        const entrypoint = $entrypoint.value.trim();
        const url = guessCollectionUrl(entrypoint, name);
        $fetchTarget.textContent = url;
        $fetchResult.innerHTML = "";
        $customResult.innerHTML = "";
      }

      // --- Fetch & Validate ---
      $fetchValidateBtn.addEventListener("click", async () => {
        const name = state.selected;
        if (!name) return;

        const entrypoint = $entrypoint.value.trim();
        const url = guessCollectionUrl(entrypoint, name);
        $fetchValidateBtn.disabled = true;
        $fetchResult.innerHTML = "";

        try {
          const res = await fetch(url, {
            headers: { Accept: "application/ld+json" },
          });
          if (!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}`);
          const data = await res.json();

          const collectionSchemaForResource = state.collections[name];
          const parsed = collectionSchemaForResource.parse(data);
          const memberCount = parsed.member?.length ?? 0;
          resultBox(
            $fetchResult,
            true,
            `Validation passed.\n${memberCount} member(s) in collection.\nTotal items: ${parsed.totalItems ?? "N/A"}`,
          );
        } catch (err) {
          if (err instanceof z.ZodError) {
            const issues = err.issues
              .map((i) => `  [${i.path.join(".")}] ${i.message}`)
              .join("\n");
            resultBox($fetchResult, false, `Validation failed:\n${issues}`);
          } else {
            resultBox($fetchResult, false, `Error: ${err.message}`);
          }
        } finally {
          $fetchValidateBtn.disabled = false;
        }
      });

      // --- Custom JSON Validation ---
      $validateCustomBtn.addEventListener("click", () => {
        const name = state.selected;
        if (!name) return;
        $customResult.innerHTML = "";

        const raw = $customJson.value.trim();
        if (!raw) {
          resultBox($customResult, false, "Please paste some JSON first.");
          return;
        }

        let data;
        try {
          data = JSON.parse(raw);
        } catch {
          resultBox(
            $customResult,
            false,
            "Invalid JSON: could not parse input.",
          );
          return;
        }

        try {
          state.schemas[name].parse(data);
          resultBox($customResult, true, "Validation passed.");
        } catch (err) {
          if (err instanceof z.ZodError) {
            const issues = err.issues
              .map((i) => `  [${i.path.join(".")}] ${i.message}`)
              .join("\n");
            resultBox($customResult, false, `Validation failed:\n${issues}`);
          } else {
            resultBox($customResult, false, `Error: ${err.message}`);
          }
        }
      });
    </script>
  </body>
</html>
